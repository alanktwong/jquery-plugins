<!DOCTYPE HTML>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<title>jQuery Publish/Subscribe: Priority Demo Page</title>

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script>
	<!--
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.js"></script>
	-->
	
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.3/underscore-min.js"></script>
	<script type="text/javascript" src="../jquery.pubsub.js"></script>
	<script type="text/javascript" src="../../log4jq/jquery.log4jq.js"></script>
<script>
$(document).ready(function() {
	var logger = $.configureLog4jq({
		enabled: true,
		level : "debug",
		targets : [
			{
				name: "console",
				enabled: true
			}
		]
	});
	
	var callbacks = {
		topic : "/priority/example",
		one : {
			notify : function(notification) {
				var data = notification.data;
				var msg = (notification.isSynchronous() ? "sync" : "async");
				msg = msg + " notification of highest priority: " + notification.publishTopic + " -> " + notification.currentTopic;
				msg = msg + ( (data.foo === "oops") ? ("... received oops and returning false:" + data.foo) : ("... received:" + data.foo) )
				if (notification.isSynchronous()) {
					$( "#receiver2", "#sync").append( "<p>" + msg + "</p>" );
				} else {
					$( "#receiver2", "#async").append( "<p>" + msg + "</p>" );
				}
				$.debug(msg);
				if ( data.foo === "oops" ) {
					return false;
				}
			}
		},
		two : {
			notify : function(notification) {
				var data = notification.data;
				var msg = (notification.isSynchronous() ? "sync" : "async");
				msg = msg + " notification of 2nd highest priority: " + notification.publishTopic + " -> " + notification.currentTopic;
				msg = msg + "... received: " + data.foo;
				if (notification.isSynchronous()) {
					$( "#receiver1", "#sync").append( "<p>" + msg + "</p>" );
				} else {
					$( "#receiver1", "#async").append( "<p>" + msg + "</p>" );
				}
				$.debug(msg);
			}
		},
		three : {
			topic : "/priority",
			notify : function(notification) {
				var data = notification.data;
				var msg = (notification.isSynchronous() ? "sync" : "async");
				msg = msg + " notification of default priority: " + notification.publishTopic + " -> " + notification.currentTopic;
				msg = msg + "... received: " + data.foo;
				if (notification.isSynchronous()) {
					$( "#parent", "#sync").append( "<p>" + msg + "</p>" );
				} else {
					$( "#parent", "#async").append( "<p>" + msg + "</p>" );
				}
			}
		},
		options : {
			progress: function(notification) {
				var msg = (notification.isSynchronous() ? "sync" : "async") + " progress: " + notification.publishTopic + " -> " + notification.currentTopic;
				$.info(msg);
			},
			done: function(notification) {
				var msg = (notification.isSynchronous() ? "sync" : "async") + " done: " + notification.publishTopic + " -> " + notification.currentTopic;
				$.info(msg);
			},
			fail: function(notification) {
				var msg = (notification.isSynchronous() ? "sync" : "async") + " fail: " + notification.publishTopic + " -> " + notification.currentTopic;
				$.info(msg);
			},
			always: function(notification) {
				var msg = (notification.isSynchronous() ? "sync" : "async") + " fail: " + notification.publishTopic + " -> " + notification.currentTopic;
				$.info(msg);
			}
		}
	}
	// we can subscribe to a topic with a priority
	$.subscribe( callbacks.topic, callbacks.two.notify, 2 );

	// we can use the highest priority possibly
	// keep other subscriptions from firing.
	$.subscribe( callbacks.topic, callbacks.one.notify, 1 );

	// the default priority is '10'.
	$.subscribe( callbacks.three.topic, callbacks.three.notify);
	
	var publishSync = function(evt) {
		var options = $.extend({data : {foo: "bar" }}, callbacks.options);
		$.publishSync( callbacks.topic, options );
		options = $.extend({data : {foo: "oops"}}, callbacks.options);
		$.publishSync( callbacks.topic, options );
	};
	
	var publishAsync = function(evt) {
		var options = $.extend({data : {foo: "bar" }}, callbacks.options);
		$.publish( callbacks.topic, options );
		options = $.extend({data : {foo: "oops"}}, callbacks.options);
		$.publish( callbacks.topic, options );
	};
	
	var $noteSync = $('#syncClick','#note').click(publishSync);
	var $noteAsync = $('#asyncClick','#note').click(publishAsync);
	
	$noteSync.click();
	$noteAsync.click();
});
</script>
</head>
<body>
	<h3>jQuery PubSub: Priority Usage</h3>
	<div id="note">
		<p id="syncClick">Synchronous part of demo works for co-publishing</p>
		<p id="asyncClick">Asynchronous part of demo works for co-publishing</p>
	</div>
	<div id="notify" style="font-size: 14px;">
		<div id="sync">
			<p id="parent"></p>
			<p id="receiver2"></p>
			<p id="receiver1"></p>
		</div>
		<div id="async">
			<p id="parent"></p>
			<p id="receiver2"></p>
			<p id="receiver1"></p>
		</div>
	</div>
</body>

</html>